{
  "info": {
    "name": "CSV Driven Fully Generic Collection",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "packages": {},
        "requests": {},
        "exec": [
          "/******** 1\ufe0f\u20e3 READ CSV ********/\r",
          "let csvApiName = pm.iterationData.get(\"API_Request_Name\");\r",
          "let runFlag    = pm.iterationData.get(\"Running_Flag\");\r",
          "\r",
          "/******** 2\ufe0f\u20e3 CURRENT CONTEXT ********/\r",
          "let currentRequest   = pm.info.requestName;\r",
          "let currentIteration = pm.info.iteration; // 0-based\r",
          "\r",
          "/******** 3\ufe0f\u20e3 UNIQUE EXECUTION MEMORY ********/\r",
          "/*\r",
          "   Same request + same iteration\r",
          "   = should run only once\r",
          "*/\r",
          "let executionKey = `EXEC_${currentRequest}_ITER_${currentIteration}`;\r",
          "\r",
          "/******** 4\ufe0f\u20e3 DUPLICATE EXECUTION CHECK ********/\r",
          "if (pm.environment.get(executionKey)) {\r",
          "    console.log(\"\u23ed\ufe0f SKIP | Already executed:\", executionKey);\r",
          "    pm.execution.skipRequest();\r",
          "    return;\r",
          "}\r",
          "\r",
          "/******** 5\ufe0f\u20e3 RUN FLAG CHECK ********/\r",
          "if (!runFlag || runFlag.toLowerCase() !== \"yes\") {\r",
          "    console.log(\"\u23ed\ufe0f SKIP | Running_Flag =\", runFlag);\r",
          "    pm.execution.skipRequest();\r",
          "    return;\r",
          "}\r",
          "\r",
          "/******** 6\ufe0f\u20e3 API NAME MATCH ********/\r",
          "if (csvApiName && csvApiName !== currentRequest) {\r",
          "    console.log(\"\u23ed\ufe0f SKIP | API mismatch\");\r",
          "    pm.execution.skipRequest();\r",
          "    return;\r",
          "}\r",
          "\r",
          "/******** 7\ufe0f\u20e3 MARK AS EXECUTED ********/\r",
          "pm.environment.set(executionKey, \"true\");\r",
          "console.log(\"\u2705 RUN |\", currentRequest, \"Iteration:\", currentIteration);\r",
          "\r",
          "\r",
          ""
        ]
      }
    },
    {
      "listen": "test",
      "script": {
        "type": "text/javascript",
        "packages": {},
        "requests": {},
        "exec": [
          "/************************************************************\r",
          " * STEP -1 : STATUS CODE CHECK\r",
          " ************************************************************/\r",
          "let actual_code   = pm.response.code;\r",
          "let expected_code = Number(pm.iterationData.get(\"Expected_Status_Code\"));\r",
          "\r",
          "if (actual_code !== expected_code) {\r",
          "    pm.test(\"Verify status code is correct\", () => {\r",
          "        pm.response.to.have.status(expected_code);\r",
          "    });\r",
          "    return;\r",
          "}\r",
          "\r",
          "/************************************************************\r",
          " * STEP 0 : READ RESPONSE & CSV\r",
          " ************************************************************/\r",
          "let actualRoot   = pm.response.json();\r",
          "let expectedRoot = JSON.parse(pm.iterationData.get(\"Expected_result\") || {});\r",
          "let rawScenario  = String(pm.iterationData.get(\"Scenareo\") || \"\").trim();\r",
          "\r",
          "let uniqueKey   = String(pm.iterationData.get(\"Uniquekey\") || \"\").trim();\r",
          "let uniqueValue = String(pm.iterationData.get(\"Uniquevalue\") || \"\").trim();\r",
          "\r",
          "/************************************************************\r",
          " * STEP 1 : RESOLVE VALIDATION ROOT (UNIQUE MERGED)\r",
          " ************************************************************/\r",
          "let resolvedRoot = resolveValidationRoot(actualRoot, uniqueKey, uniqueValue);\r",
          "\r",
          "if (!resolvedRoot) {\r",
          "    pm.test(\"Verify unique object exists\", () => {\r",
          "        pm.expect.fail(`\u274c Object with ${uniqueKey}=${uniqueValue} not found`);\r",
          "    });\r",
          "    return;\r",
          "}\r",
          "\r",
          "actualRoot = resolvedRoot;\r",
          "\r",
          "/************************************************************\r",
          " * STEP 2 : FLATTEN EXPECTED JSON\r",
          " ************************************************************/\r",
          "let expectedMap  = flattenExpected(expectedRoot);\r",
          "let expectedKeys = Object.keys(expectedMap);\r",
          "\r",
          "/************************************************************\r",
          " * STEP 3 : BUILD SCENARIO LIST\r",
          " ************************************************************/\r",
          "let userScenarios = rawScenario\r",
          "    ? rawScenario.split(\",\").map(s => s.trim())\r",
          "    : [];\r",
          "\r",
          "let scenarioList = expectedKeys.map((key, index) => {\r",
          "    return userScenarios[index] || buildScenarioName(key, expectedMap[key]);\r",
          "});\r",
          "\r",
          "/************************************************************\r",
          " * STEP 4 : VALIDATION EXECUTION\r",
          " ************************************************************/\r",
          "expectedKeys.forEach((path, index) => {\r",
          "\r",
          "    let expectedValue = expectedMap[path];\r",
          "    let actualValue   = getValueByPath(actualRoot, path);\r",
          "    let scenarioName  = scenarioList[index];\r",
          "\r",
          "    pm.test(scenarioName, () => {\r",
          "\r",
          "        /* {{var}} \u2192 NOT_NULL + SET VARIABLE */\r",
          "        if (isVariable(expectedValue)) {\r",
          "            let varName = extractVarName(expectedValue);\r",
          "\r",
          "            pm.expect(\r",
          "                actualValue !== null &&\r",
          "                actualValue !== undefined &&\r",
          "                actualValue !== \"\",\r",
          "                `\u274c ${path} expected NOT_NULL for {{${varName}}}`\r",
          "            ).to.be.true;\r",
          "\r",
          "            pm.collectionVariables.set(varName, actualValue);\r",
          "            return;\r",
          "        }\r",
          "\r",
          "        /* NOT_NULL */\r",
          "        if (expectedValue === \"NOT_NULL\") {\r",
          "            pm.expect(\r",
          "                actualValue !== null &&\r",
          "                actualValue !== undefined &&\r",
          "                actualValue !== \"\",\r",
          "                `\u274c ${path} expected NOT_NULL`\r",
          "            ).to.be.true;\r",
          "            return;\r",
          "        }\r",
          "\r",
          "        /* REGEX */\r",
          "        if (isRegex(expectedValue)) {\r",
          "            let regex = new RegExp(expectedValue.replace(\"REGEX:\", \"\"));\r",
          "            pm.expect(\r",
          "                regex.test(String(actualValue)),\r",
          "                `\u274c ${path} regex mismatch`\r",
          "            ).to.be.true;\r",
          "            return;\r",
          "        }\r",
          "\r",
          "        /* STRING CONTAINS */\r",
          "        if (typeof expectedValue === \"string\" && typeof actualValue === \"string\") {\r",
          "            pm.expect(\r",
          "                actualValue.includes(expectedValue),\r",
          "                  \r",
          "              `\u274c ${path} mismatch | expected: ${expectedValue} | actual: ${actualValue}`\r",
          "            ).to.be.true;\r",
          "            return;\r",
          "        }\r",
          "\r",
          "        /* EXACT MATCH */\r",
          "       pm.expect(\r",
          "    actualValue,\r",
          "    `\u274c ${path} mismatch | expected: ${expectedValue} | actual: ${actualValue}`\r",
          ").to.eql(expectedValue);\r",
          "\r",
          "    });\r",
          "});\r",
          "\r",
          "/************************************************************\r",
          " * \ud83d\udd27 HELPER FUNCTIONS (BOTTOM)\r",
          " ************************************************************/\r",
          "\r",
          "/* UNIQUE ROOT RESOLVER */\r",
          "function resolveValidationRoot(actualRoot, uniqueKey, uniqueValue) {\r",
          "\r",
          "console.log(\"in the function\");\r",
          "    if (!uniqueKey || !uniqueValue) {\r",
          "        return actualRoot; // full response validation\r",
          "    }\r",
          "\r",
          "    let foundObject = null;\r",
          "\r",
          "    (function deepSearch(node) {\r",
          "        if (!node || foundObject) return;\r",
          "\r",
          "        if (Array.isArray(node)) {\r",
          "            node.forEach(deepSearch);\r",
          "            return;\r",
          "        }\r",
          "\r",
          "        if (typeof node === \"object\") {\r",
          "            if (\r",
          "                node.hasOwnProperty(uniqueKey) &&\r",
          "                String(node[uniqueKey]) === String(uniqueValue)\r",
          "            ) {\r",
          "                foundObject = node;\r",
          "                return;\r",
          "            }\r",
          "            Object.values(node).forEach(deepSearch);\r",
          "        }\r",
          "    })(actualRoot);\r",
          "\r",
          "    return foundObject; // null if not found\r",
          "}\r",
          "\r",
          "/* GET VALUE BY PATH */\r",
          "function getValueByPath(obj, path) {\r",
          "    return path\r",
          "        .replace(/\\[(\\d+)\\]/g, '.$1')\r",
          "        .split('.')\r",
          "        .reduce((acc, key) => acc && acc[key], obj);\r",
          "}\r",
          "\r",
          "/* FLATTEN EXPECTED JSON */\r",
          "function flattenExpected(obj, prefix = \"\", out = {}) {\r",
          "    for (let key in obj) {\r",
          "        let path = prefix ? `${prefix}.${key}` : key;\r",
          "        let val = obj[key];\r",
          "\r",
          "        if (typeof val === \"object\" && val !== null && !Array.isArray(val)) {\r",
          "            flattenExpected(val, path, out);\r",
          "        } else {\r",
          "            out[path] = val;\r",
          "        }\r",
          "    }\r",
          "    return out;\r",
          "}\r",
          "\r",
          "/* AUTO SCENARIO NAME BUILDER */\r",
          "function buildScenarioName(path, expectedValue) {\r",
          "    let keyName = path.split(\".\").pop().replace(/([A-Z])/g, \" $1\").toLowerCase();\r",
          "\r",
          "    if (isVariable(expectedValue)) return `Capture ${keyName} into variable`;\r",
          "    if (expectedValue === \"NOT_NULL\") return `Verify ${keyName} is not null`;\r",
          "    if (isRegex(expectedValue)) return `Verify ${keyName} format`;\r",
          "    if (expectedValue === null) return `Verify ${keyName} is null`;\r",
          "\r",
          "    return `Verify ${keyName} value`;\r",
          "}\r",
          "\r",
          "/* UTIL FUNCTIONS */\r",
          "function isVariable(val) {\r",
          "    return typeof val === \"string\" && val.startsWith(\"{{\") && val.endsWith(\"}}\");\r",
          "}\r",
          "\r",
          "function extractVarName(val) {\r",
          "    return val.slice(2, -2).trim();\r",
          "}\r",
          "\r",
          "function isRegex(val) {\r",
          "    return typeof val === \"string\" && val.startsWith(\"REGEX:\");\r",
          "}\r",
          ""
        ]
      }
    }
  ],
  "item": [
    {
      "name": "Super_Admin_login",
      "request": {
        "auth": {
          "type": "bearer",
          "bearer": [
            {
              "key": "token",
              "value": "{{}}",
              "type": "string"
            }
          ]
        },
        "method": "POST",
        "header": [],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"merchantId\": 0,\n  \"username\": \"admin\",\n  \"password\": \"Admin@123\"\n}",
          "options": {
            "raw": {
              "language": "json"
            }
          }
        },
        "url": {
          "raw": "http://65.0.92.207:8081/api/v1/auth/login",
          "protocol": "http",
          "host": [
            "65",
            "0",
            "92",
            "207"
          ],
          "path": [
            "api",
            "v1",
            "auth",
            "login"
          ],
          "query": [],
          "port": "8081"
        }
      },
      "response": []
    },
    {
      "name": "Marchant_Creation",
      "request": {
        "auth": {
          "type": "bearer",
          "bearer": [
            {
              "key": "token",
              "value": "{{accessToken}}",
              "type": "string"
            }
          ]
        },
        "method": "POST",
        "header": [],
        "body": {
          "mode": "raw",
          "raw": "{ \"merchantName\": \"sushant\", \"email\": \"sushant123@gmail.com\", \"gstin\": \"29ABCDE1234F1Z5\", \"username\": \"sushant\", \"password\": \"Sush@123\", \"phone\": \"7083939302\", \"address\": \"Kolhapur\", \"fssaiLicense\": \"12300000000000\" }",
          "options": {
            "raw": {
              "language": "json"
            }
          }
        },
        "url": {
          "raw": "http://65.0.92.207:8081/api/v1/merchants",
          "protocol": "http",
          "host": [
            "65",
            "0",
            "92",
            "207"
          ],
          "path": [
            "api",
            "v1",
            "merchants"
          ],
          "query": [],
          "port": "8081"
        }
      },
      "response": []
    },
    {
      "name": "Get_All_marchants",
      "request": {
        "auth": {
          "type": "bearer",
          "bearer": [
            {
              "key": "token",
              "value": "{{accessToken}}",
              "type": "string"
            }
          ]
        },
        "method": "GET",
        "header": [],
        "url": {
          "raw": "http://65.0.92.207:8081/api/v1/merchants?search=7083939302&status=true",
          "protocol": "http",
          "host": [
            "65",
            "0",
            "92",
            "207"
          ],
          "path": [
            "api",
            "v1",
            "merchants"
          ],
          "query": [
            {
              "key": "search",
              "value": "7083939302"
            },
            {
              "key": "status",
              "value": "true"
            }
          ],
          "port": "8081"
        }
      },
      "response": []
    },
    {
      "name": "Delete_Marchant",
      "request": {
        "auth": {
          "type": "bearer",
          "bearer": [
            {
              "key": "token",
              "value": "{{accessToken}}",
              "type": "string"
            }
          ]
        },
        "method": "DELETE",
        "header": [],
        "url": {
          "raw": "http://65.0.92.207:8081/api/v1/merchants/{{Merchant_id}}",
          "protocol": "http",
          "host": [
            "65",
            "0",
            "92",
            "207"
          ],
          "path": [
            "api",
            "v1",
            "merchants",
            "{{Merchant_id}}"
          ],
          "query": [],
          "port": "8081"
        }
      },
      "response": []
    }
  ]
}